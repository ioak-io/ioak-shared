_format_version: "3.0"
_transform: true

services:
  - name: auth-service
    url: http://auth-service:2000
    routes:
      - name: auth-route
        paths:
          - /auth
        strip_path: true

  - name: express-service
    url: http://express-service:3000
    routes:
      - name: express-route
        paths:
          - /express
        strip_path: true
    plugins:
      - name: jwt
        config:
          key_claim_name: azp
          claims_to_verify:
            - exp
            - iss
            - aud
          allowed_iss:
            - "https://keycloak.ioak.io/realms/echo"
          allowed_aud:
            - "account"
      - name: request-transformer
        config:
          add:
            headers:
              - "x-jwt-iss:$(jwt_claim_iss)"
              - "x-jwt-aud:$(jwt_claim_aud)"
              - "x-jwt-azp:$(jwt_claim_azp)"
              - "x-jwt-sub:$(jwt_claim_sub)"
              - "x-jwt-typ:$(jwt_claim_typ)"
              - "x-jwt-sid:$(jwt_claim_sid)"
          remove:
            headers:
              - authorization

consumers:
  - username: jwt-for-echo

jwt_secrets:
  - consumer: jwt-for-echo
    key: echo # must match `azp` in token
    algorithm: RS256
    rsa_public_key: |
      -----BEGIN PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAoR3TxySL0FSM2rALzQ3J
      BrEK2yWDy/pkCaLY2PdooNh/USQdJIQ4dHlgahB85SnSHF8/lS4qfS4VSJPUbUnc
      tT4OdpUAJfcAErldbTcCeR8zaaGKUMekb4XoO1GMS5up0ymjTF1PJB4/YxUMAOL1
      4l5plH6/PB1vJWtFQQhTiFJafoz0EWLFAhRvpn0YEayUQ57yO6dY8qVGz12JDNeM
      AUA3vScnuS5tNxPOyI+sjgwM5W9EMjLTzW/iLNmapmCvkektUngxPjJQJIrjQ1aK
      BJGGzrNaj3mRpfvi4cmPlAM9ph//J85GtViPKGKONQ3+wlDiK+Yq9Xs5lLDsde32
      YQIDAQAB
      -----END PUBLIC KEY-----
